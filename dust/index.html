<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<title>くまっぷ</title>

	<link
		rel="stylesheet"
		href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
	/>

	<style>
	#map {
		width: 100%;
		height: 80dvh;
	}
	.controls {
		padding: 10px;
	}
	.popup-image {
		max-width: 100%;
		height: auto;
	}
	</style>
</head>
<body>
	<h3>くまっぷ</h3>

	<div id="map"></div>

	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script>
		const host = "localhost";
		const port = 3000;

		const map = L.map("map").setView([0, 0], 2);
		const markerLayer = L.layerGroup().addTo(map);
		const circleLayer = L.layerGroup().addTo(map);
		const speedKmh = 50; // Speed in km/h for circle expansion
		let socket;

		let url = "";
		fetch("https://pinattutaro.github.io/dcon_kumap/url.txt")
			.then(res => res.text())
			.then(text => {
				url = text.trim();
				console.log("Fetched URL:", url);
				socket = new WebSocket(`wss://${url.replace(/^https?:\/\//, '')}`);
				connect();
			})
			.catch(err => {
				console.error("Error fetching URL:", err);
			});

		const min = 720;

		const addPin = (e) => {
			const creationTime = Date.parse(e.time);
			const elapsedMs = Date.now() - creationTime;
			const elapsedHours = elapsedMs / (1000 * 60 * 60);

			const timeText = (() => {
				if (elapsedMs < 60000) return "now";
				const minutes = Math.floor(elapsedMs / 60000);
				const hours = Math.floor(minutes / 60);
				if (hours > 0) {
					return `${hours}h${minutes % 60}m ago`;
				}
				return `${minutes}m ago`;
			})();


			// --- Marker and Popup ---
			const popupContainer = document.createElement('div');
			const timeDiv = document.createElement('div');
			timeDiv.textContent = timeText;
			timeDiv.style.cursor = 'pointer';

			const imgElement = document.createElement('img');
			const imageUrl = new URL(e.image_path.replace(/\\/g, '/'), url);
			imgElement.src = imageUrl.href;
			imgElement.alt = 'location image';
			imgElement.className = 'popup-image';
			imgElement.style.display = 'none';
			imgElement.style.cursor = 'pointer';

			imgElement.onerror = () => {
				console.error("Image load error:", imgElement.src);
				imgElement.alt = 'Image load error';
				if (marker.getPopup().isOpen()) marker.getPopup().update();
			}

			timeDiv.addEventListener('click', () => {
				timeDiv.style.display = 'none';
				imgElement.style.display = 'block';
				if (marker.getPopup().isOpen()) marker.getPopup().update();
			});

			imgElement.addEventListener('click', () => {
				imgElement.style.display = 'none';
				timeDiv.style.display = 'block';
				if (marker.getPopup().isOpen()) marker.getPopup().update();
			});
			
			imgElement.onload = () => {
				if (marker.getPopup().isOpen()) marker.getPopup().update();
			};

			popupContainer.appendChild(timeDiv);
			popupContainer.appendChild(imgElement);

			const marker = L.marker([e.lat, e.lon])
				.addTo(markerLayer)
				.bindPopup(popupContainer, { closeOnClick: false , autoClose: false, maxWidth: 300, minWidth: 50 })
				.openPopup();

			// --- Expanding Circle ---
			const radius = elapsedHours * speedKmh * 1000; // radius in meters
			console.log(((min - (elapsedMs / (1000 * 60))) / min)**2);
			L.circle([e.lat, e.lon], {
				radius: radius,
				color: 'red',
				weight: 1,
				fillOpacity: 0.5*((min - (elapsedMs / (1000 * 60))) / min)**2,
				creationTime: creationTime 
			}).addTo(circleLayer);
		}

		const connect = () => {
			socket.onopen = () => {
				console.log("WebSocket connected");
				status.textContent = "Connected to server.";
				socket.send(JSON.stringify({
					type: "location",
					min: min
				}));
			}

			socket.onmessage = (mes) => {
				const data = JSON.parse(mes.data);
				console.log(data);

				if(!data) return;

				switch(data.type) {
					case "location":
						markerLayer.clearLayers(); // Clear existing markers
						circleLayer.clearLayers(); // Clear existing circles
						data.data.forEach(e => {
							addPin(e);
						});
						break;
					case "add": 
						addPin(data.data);
						break;
				}
			}

			socket.onclose = () => {
				console.log("WebSocket disconnected, retrying in 3 seconds...");
				status.textContent = "Disconnected. Retrying...";
				setTimeout(connect, 3000);
			}
		}

		L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
			attribution: "© OpenStreetMap contributors"
		}).addTo(map);

		map.locate({ setView: true, maxZoom: 16 });

		map.on('locationfound', function(e) {
			console.log("Location found:", e.latlng);
			const userLatLng = e.latlng;
			let isInside = false;

			circleLayer.getLayers().forEach(circle => {
				const circleLatLng = circle.getLatLng();
				const circleRadius = circle.getRadius();
				const distance = map.distance(userLatLng, circleLatLng);

				if (distance < circleRadius) {
					isInside = true;
				}
			});

			if (isInside) {
				alert('現在地は円の中にあります。');
			} else {
				alert('現在地はどの円の中にもありません。');
			}
		});

		map.on('locationerror', function (e) {
			alert(e.message);
		});

		// Update circles every second
		// setInterval(() => {
		// 	circleLayer.getLayers().forEach(circle => {
		// 		const elapsedMs = Date.now() - circle.options.creationTime;
		// 		const elapsedHours = elapsedMs / (1000 * 60 * 60);
		// 		const newRadius = elapsedHours * speedKmh * 1000;
		// 		circle.setRadius(newRadius);
		// 	});
		// }, 1000*60);

		// const addLocationBtn = document.getElementById('addLocationBtn');
		// const imageFile = document.getElementById('imageFile');
		// const status = document.getElementById('status');

		// addLocationBtn.addEventListener('click', () => {
		// 	status.textContent = 'Getting current location...';
		// 	navigator.geolocation.getCurrentPosition(position => {
		// 		const lat = position.coords.latitude;
		// 		const lon = position.coords.longitude;

		// 		const formData = new FormData();
		// 		formData.append('lat', lat);
		// 		formData.append('lon', lon);
				
		// 		if (imageFile.files[0]) {
		// 			formData.append('image', imageFile.files[0]);
		// 		}

		// 		status.textContent = 'Uploading...';
		// 		fetch(`/upload`, {
		// 			method: 'POST',
		// 			body: formData
		// 		}).then(response => {
		// 			if (response.ok) {
		// 				status.textContent = 'Upload successful!';
		// 				imageFile.value = ''; // Reset file input
		// 				// Request updated locations
		// 				socket.send(JSON.stringify({ type: "location" }));
		// 			} else {
		// 				status.textContent = 'Upload failed.';
		// 			}
		// 		}).catch(error => {
		// 			status.textContent = 'Upload error: ' + error.message;
		// 			console.error('Error uploading:', error);
		// 		});

		// 	}, error => {
		// 		status.textContent = 'Could not get location: ' + error.message;
		// 		console.error(error);
		// 	});
		// });

	</script>

</body>
</html>
