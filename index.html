<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>くまっぷ</title>
    <link
		rel="stylesheet"
		href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
	/>
    <style>
        @keyframes scroll-text {
            from {
                transform: translateX(0%);
            }
            to {
                transform: translateX(-100%);
            }
        }

        :root {
            --main-color: hsl(206, 75%, 11%);
            --sub-color: hsl(26, 75%, 55%);
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100dvw;
            height: 100dvh;
            font-size: 12px;
            overflow: hidden;
        }

        .page {
            text-align: center;
            font-weight: bold;

            display: flex;
            flex-direction: column;

            height: 100%;



            & > .head {
                font-size: 2.5rem;
                /* padding-top: 0.8em; */
                padding: 0.1em;
                background: var(--main-color);
                color: white;
            }

            & > .main {
                flex: 1;
                position: relative;

                & > div {
                    height: 100%;
                    width: 100%;
                    box-sizing: border-box;
                    position: absolute;
                    inset: 0;
                }

                & > #map {
                    z-index: 0;
                    .leaflet-control-container {
                        /* padding: 10px; */
                        display: none;
                    }
                    .popup-image {
                        max-width: 100%;
                        height: auto;
                    }
                }

                & > .controlls {
                    padding: 1rem;
                    display: grid;
                    grid-template-rows: auto 6rem;
                    pointer-events: none;
                    z-index: 1;

                    & > .time {
                        display: inline-flex;
                        flex-direction: column;
                        align-items: flex-start;
                        justify-content: center;
                        gap: 1px;
                        border-radius: 1rem;

                        & > .t {
                            pointer-events: all;
                            user-select: none;
                            cursor: pointer;
                            background-color: var(--main-color);
                            color: white;
                            width: 5rem;
                            height: 3rem;
                            display: grid;
                            place-content: center;
                            border-radius: 0.2rem;

                            &.selected {
                                background-color: var(--sub-color);
                            }
                        }
                    }

                    & > .info {
                        & > .news {
                            pointer-events: all;
                            width: 100%;
                            height: 100%;
                            border: solid 1px #000;
                            border-radius: 1rem;
                            background: var(--main-color);
                            padding: 0.1rem;

                            display: grid;
                            place-items: center;
                            grid-template-columns: 6rem auto;
                            grid-template-rows: 1fr 1fr;
                            grid-template-areas: "a b" "a c";

                            & > img {
                                grid-area: a;
                                display: grid;
                                width: 70%;
                                opacity: 0.3;

                                &.danger {
                                    opacity: 1;
                                }
                            }

                            & > div {
                                width: 100%;
                                text-align: left;
                                font-size: 1.2rem;
                                color: white;
                                white-space: nowrap;
                                overflow: hidden;

                                &:first-of-type {
                                    color: var(--sub-color);

                                    & > span {
                                        color: white;
                                    }
                                }

                                &:nth-of-type(2) {
                                    scrollbar-width: none; /* for Firefox */
                                    -ms-overflow-style: none; /* for IE and Edge */
                                    overflow: hidden;
                                    position: relative;
                                    
                                    &::-webkit-scrollbar {
                                        display: none; /* for Chrome, Safari, and Opera */
                                    }

                                    & > p {
                                        display: inline-block;
                                        /* transition: transform 10s linear; */
                                        /* animation: scroll-text 10s linear infinite; */

                                        &:hover {
                                            animation: scroll-text 10s linear infinite;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="head">くまっぷ</div>
        <div class="main">
            <div id="map"></div>
            <div class="controlls">
                <div class="time">
                    <div class="t" data-value="60">1時間</div>
                    <div class="t selected" data-value="600">10時間</div>
                    <div class="t" data-value="1440">1日</div>
                    <div class="t" data-value="10080">1週間</div>
                </div>
                <div class="info">
                    <div class="news">
                        <img src="img/alert.svg" alt="alert">
                        <div>熊出没情報: <span>--:--</span></div>
                        <div><p>現在地が取得できません。</p></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- <div class="foot"></div> -->
    </div>

	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script>
		const host = "localhost";
		const port = 3000;
		let min = 10*60;

        const bounds = L.latLngBounds(
            L.latLng(-85.05112878, -180),
            L.latLng( 85.05112878,  180)
        )

		const map = L.map("map", {
			minZoom: 2,
			maxBounds: bounds,
			maxBoundsViscosity: 1.0,
			worldCopyJump: true
		}).setView([0,0], 2);
		const markerLayer = L.layerGroup().addTo(map);
		const circleLayer = L.layerGroup().addTo(map);
		const speedKmh = 50; // Speed in km/h for circle expansion
        const dangerRadiusM = 3000; // Danger radius in meters
		let socket;

		let url = "";
		fetch("https://pinattutaro.github.io/dcon_kumap/url.txt")
			.then(res => res.text())
			.then(text => {
				url = text.trim();
				console.log("Fetched URL:", url);
				socket = new WebSocket(`wss://${url.replace(/^https?:\/\//, '')}`);
                // url = "http://localhost:3000";
                // socket = new WebSocket("ws://localhost:3000");
				connect();
			})
			.catch(err => {
				console.error("Error fetching URL:", err);
			});

		const addPin = async (e) => {
			const creationTime = Date.parse(e.time);
			const elapsedMs = Date.now() - creationTime;
			const elapsedHours = elapsedMs / (1000 * 60 * 60);

			const timeText = (() => {
				if (elapsedMs < 60000) return "now";
				const minutes = Math.floor(elapsedMs / 60000);
				const hours = Math.floor(minutes / 60);
				if (hours > 0) {
					return `${hours}h${minutes % 60}m ago`;
				}
				return `${minutes}m ago`;
			})();


			// --- Marker and Popup ---
			const popupContainer = document.createElement('div');
			const timeDiv = document.createElement('div');
			timeDiv.textContent = timeText;
			timeDiv.style.cursor = 'pointer';

			const imgElement = document.createElement('img');
            console.log(e.image_path);

            const r = await fetch(`${url}/image/${e.image_path}`, {
                method: 'GET',
                headers: { 
                    "ngrok-skip-browser-warning": "true" ,
                }
            });
            const blob = await r.blob();
            const imageUrl = URL.createObjectURL(blob);

            // const imageUrl = new URL(e.image_path, url);
			            imgElement.src = imageUrl;			imgElement.alt = 'location image';
			imgElement.className = 'popup-image';
			imgElement.style.display = 'none';
			imgElement.style.cursor = 'pointer';

			imgElement.onerror = () => {
				console.error("Image load error:", imgElement.src);
				imgElement.alt = 'Image load error';
				if (marker.getPopup().isOpen()) marker.getPopup().update();
			}

			timeDiv.addEventListener('click', () => {
				timeDiv.style.display = 'none';
				imgElement.style.display = 'block';
				if (marker.getPopup().isOpen()) marker.getPopup().update();
			});

			imgElement.addEventListener('click', () => {
				imgElement.style.display = 'none';
				timeDiv.style.display = 'block';
				if (marker.getPopup().isOpen()) marker.getPopup().update();
			});
			
			imgElement.onload = () => {
				if (marker.getPopup().isOpen()) marker.getPopup().update();
			};

			popupContainer.appendChild(timeDiv);
			popupContainer.appendChild(imgElement);

			const marker = L.marker([e.lat, e.lon])
				.addTo(markerLayer)
				.bindPopup(popupContainer, { closeOnClick: false , autoClose: false, minWidth: 50, maxWidth: 300 })
				.openPopup();

			// --- Expanding Circle ---
			const radius = elapsedHours * speedKmh * 1000; // radius in meters
			console.log(((min - (elapsedMs / (1000 * 60))) / min)**2);
			L.circle([e.lat, e.lon], {
				radius: radius,
				color: 'red',
				weight: 1,
				opacity: 0.7 + 0.3*((min - (elapsedMs / (1000 * 60))) / min)**2, // Border opacity
				fillOpacity: .5*((min - (elapsedMs / (1000 * 60))) / min)**2,
				creationTime: creationTime 
			}).addTo(circleLayer);
		}

        const announce = () => {
            console.log("Announce called");
            const nearest = getNearest();
            if (!nearest) return;
            const {distance, creationTime, isBound} = nearest;
            // console.log(new Date(creationTime));
            const infos = document.querySelector('.news').children;
            if (isBound || distance < dangerRadiusM) {
                infos[0].classList.add('danger');
                infos[1].children[0].innerHTML = `${new Date(creationTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                infos[2].children[0].innerHTML = `${distance > 1000 ? (distance / 1000).toFixed(1) + 'km' : distance + 'm'}先で熊の出没を確認しました。`;
            } else {
                infos[0].classList.remove('danger');
                infos[1].children[0].innerHTML = "--:--";
                infos[2].children[0].innerHTML = `現在、近くで熊の出没は確認されていません。`;

                console.log(userLatLng);
                if (!userLatLng) {
                    infos[2].children[0].innerHTML = `現在地が取得できません。`;
                    return;
                }
            }
        }

		const connect = () => {
			socket.onopen = () => {
				console.log("WebSocket connected");
				status.textContent = "Connected to server.";
				socket.send(JSON.stringify({
					type: "location",
					min: min
				}));
			}

			socket.onmessage = (mes) => {
				const data = JSON.parse(mes.data);
				console.log(data);

				if(!data) return;

				switch(data.type) {
					case "location":
						markerLayer.clearLayers(); // Clear existing markers
						circleLayer.clearLayers(); // Clear existing circles
						data.data.forEach(e => {
							addPin(e);
						});
                        announce();
                        break;  
					case "add": 
						addPin(data.data);
                        announce();
                        break;
				}
			}

			socket.onclose = () => {
				console.log("WebSocket disconnected, retrying in 3 seconds...");
				status.textContent = "Disconnected. Retrying...";
				setTimeout(connect, 3000);
			}
		}

		L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
			// noWrap: true,
            bounds: bounds,
		}).addTo(map);

		map.locate({ 
            center: [35, 135],
            setView: true, 
            maxZoom: 18, 
        });

        const getNearest = () => {
            if (!userLatLng) return null;

            let nearestCircle = null;
            let minDistance = Infinity;
            let isBound = false;

            circleLayer.getLayers().forEach(circle => {
                // console.log(circle);
                const circleLatLng = circle.getLatLng();
                const circleRadius = circle.getRadius();
                const distance = map.distance(userLatLng, circleLatLng);

                if (distance < minDistance) {
                    minDistance = distance;
                    nearestCircle = circle;
                }

                if (distance < circleRadius) {
                    isBound = true;
                }
            });

            if (nearestCircle) {
                return {
                    distance: Math.round(minDistance),
                    creationTime: nearestCircle.options.creationTime,
                    isBound: isBound
                };
            } else {
                return null;
            }
        }

        let userLatLng = null;

		map.on('locationfound', function(e) {
			console.log("Location found:", e.latlng);
			userLatLng = e.latlng;

            // const nearest = getNearest();
			// if (nearest && nearest.isBound) {
			// 	alert(`最も近いピンまで${Math.round(nearest.distance)}mです。`);
			// } else {
			// 	alert('現在地はどの円の中にもありません。');
			// }
            announce();
		});

		map.on('locationerror', function (e) {
			console.log(e.message);
		});

        const t = document.querySelectorAll('.t');
        t.forEach(el => {
            el.addEventListener('click', () => {
                t.forEach(i => i.classList.remove('selected'));
                el.classList.add('selected');

                const value = parseInt(el.dataset.value, 10);

                min = value;
                socket.send(JSON.stringify({
                    type: "location",
                    min: min
                }));
            });
        });
	</script>
</body>
</html>